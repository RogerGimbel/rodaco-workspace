# 2026-02-13 — Pi Docker Migration & Cleanup

## Docker Migration to SanDisk (Completed)
- Migrated Docker data-root from SD card (`/var/lib/docker`) to SanDisk USB drive (`/mnt/docker`)
- SanDisk: `/dev/sda1`, UUID `67971806-e4c4-4004-af9b-143a3b0dd0a6`, 229GB ext4
- `daemon.json` updated: `"data-root": "/mnt/docker"`
- fstab entry added with `nofail` flag
- udev rule created (`/etc/udev/rules.d/99-ignore-sandisk.rules`) to prevent udisks2 double-mount
- All 31 containers verified running and healthy

## SD Card Cleanup (92% → 56%)
| Action | Space Freed |
|--------|------------|
| Old `/var/lib/docker` deleted | ~17 GB |
| 18 core dumps in home dir | ~3.0 GB |
| Docker dangling images pruned (10) | ~2.4 GB |
| Old kernels removed (6.12.47) | ~400 MB |
| APT cache cleaned | ~147 MB |
| InfluxDB purged (package + /var/lib/influxdb) | ~513 MB |

## Services Disabled
- **CUPS** (print server) — disabled + stopped
- **rpcbind** (NFS) — disabled + stopped
- **InfluxDB** — fully purged (package + data + masked)
- **Kodi** — killed, LightDM autostart commented out (`/etc/lightdm/lightdm.conf`)
- **Pironman5 dashboard (pm_dashboard)** — removed (was causing InfluxDB error spam)
- Core dumps disabled: `kernel.core_pattern=|/bin/false` in `/etc/sysctl.d/50-coredump.conf`

## Pironman5 Changes
- Fan mode changed from 0 (Always On) → 3 (Balanced, temp-based)
- Dashboard removed (pm_dashboard uninstalled)
- No more InfluxDB error spam in logs
- Vibration switch config mismatch noted: config says `pull_up: false`, logs show `pull_up=True`

## Services Started
- **Jellyfin** — was in `Created` state, started manually
- **Cloudflared** — was in `Created` state, started manually
- **Home Assistant** — supervisor restarted, all sidecars came up
- **Mission Control** — wasn't running on Intel MacBook, started via `start.sh`

## Pi Reliability Action Plan (from comprehensive audit)

### Phase 1 — Critical
1. Disable wlan1 (duplicate IP problem — eth0 AND wlan1 both 10.0.0.20)
2. Enable hardware watchdog (bcm2835_wdt — auto-reboot on kernel hang)
3. Add `nofail` to SSD fstab entry (prevents emergency mode if SSD fails)
4. Lower swappiness to 10 (currently 60, too aggressive for SD/USB storage)

### Phase 2 — Cleanup
5. Disable unnecessary services (ModemManager, winbind, nfs-blkmap, cloud-init, wayvnc)
6. Cap journal size (prevent SD card fill over time)
7. Add weekly Docker prune cron (prevent image accumulation)

### Phase 3 — Hardening
8. Fix storage alert to check all 3 drives (currently only monitors /mnt/media)
9. Fix backup script to use Tailscale IP as fallback (currently only LAN 10.0.0.11)
10. Add backup failure notifications (currently fails silently)

## Pi Reliability Action Plan — Phase 4 (from final audit pass)

### Phase 4A — Quick Fixes (no reboot)
1. Kill rpi-connect-wayvnc crash loop (user service, spamming journal every 5s)
2. Disable unnecessary user services (PipeWire, PulseAudio, WirePlumber, mpris-proxy, GNOME keyring, rpi-connect, filter-chain)
3. Fix UDP buffers (net.core.rmem_max/wmem_max → 7340032 — fixes Caddy/Cloudflared QUIC warnings)
4. Enable Docker live-restore (`"live-restore": true` in daemon.json — containers survive daemon restarts)
5. Harden SSH (PermitRootLogin no, PasswordAuthentication no, key-only)

### Phase 4B — Medium Priority (soon)
6. Install smartmontools for SSD/SanDisk health monitoring
7. Set filesystem check intervals (SD card has 63 mounts, never checked since Dec 4 2025)
8. Restrict Docker port bindings — many services on 0.0.0.0 instead of Tailscale-only (Sonarr 8989, Radarr 7878, qBit 8090, SABnzbd 8183, Jellyseerr 5055 all LAN-exposed)
9. Consider fail2ban for SSH brute-force protection
10. Fix HA bluetooth errors (disable BT integration in HA config since bluetooth service is off)

### Notes on security
- No firewall (UFW not installed, iptables only has Tailscale rules)
- All Docker ports exposed to LAN via 0.0.0.0
- SSH is all defaults (root login not explicitly denied, passwords not explicitly disabled)

## Remaining Issues (TODO — Pironman)
1. Pironman touch bug — vibration switch toggling fans instead of waking OLED
2. LightDM still enabled (pointless without Kodi)
3. Samba running — may not be needed
4. Pironman5 software update — check SunFounder GitHub
5. Bluetooth enabled — probably unused

## Audit Log
- [07:20] EXEC: Docker migration audit — all checks passed
- [07:25] EXEC: `docker start jellyfin` + `docker start cloudflared`
- [07:25] EXEC: `docker start hassio_supervisor`
- [07:25] EXEC: Mission Control started via `start.sh`
- [07:35] EXEC: `sudo umount /media/rogergimbel/DOCKER`
- [07:38] EXEC: `sudo rm -rf /var/lib/docker` (17GB freed)
- [07:45] EXEC: udev rule created for SanDisk
- [07:50] EXEC: Core dumps deleted, core pattern disabled
- [07:52] EXEC: CUPS + rpcbind disabled
- [07:55] EXEC: Docker image prune (2.4GB), old kernels removed
- [08:05] EXEC: Kodi killed, LightDM autostart disabled
- [08:08] EXEC: InfluxDB stopped, masked, purged
- [08:08] EXEC: Pironman5 dashboard removed, fan mode → Balanced
- [08:10] EXEC: Pironman5 restarted — clean logs, no errors
- [08:30] EXEC: Pironman5 vibration switch code analysis — `self.pull` vs `self.pull_up` bug found
- [08:35] EXEC: Vibration sensor test — no "Vibration detected" in logs when Roger tapped case — likely hardware issue (disconnected/broken)
- [09:00] EXEC: Tailscale watchdog deployed (`/usr/local/bin/tailscale-watchdog.sh` + systemd service)
- [09:30] EXEC: Comprehensive Pi diagnostics gathered for full audit

## Comprehensive Audit Findings (Pending Remediation)
**Critical:**
- `/mnt/media` fstab entry missing `nofail` — could block boot if SSD fails
- No hardware watchdog configured (bcm2835_wdt available but unused)
- Telegram bot token exposed in backup script on Pi

**High:**
- Dual-NIC routing: eth0 + wlan1 both on 10.0.0.20/24 — potential routing issues
- Host resolv.conf points to router (10.0.0.1) not local dnsmasq — split DNS bypassed for Pi itself
- Backup script doesn't verify MacBook reachability before rsync

**Medium:**
- ModemManager & cloud-init services running unnecessarily
- Home Assistant & Portainer containers lack Docker healthchecks
- Bluetooth & Samba disabled but not masked

## Tailscale Watchdog
- Script: `/usr/local/bin/tailscale-watchdog.sh`
- Service: `tailscale-watchdog.service` (systemd, auto-start)
- Pings 1.1.1.1 + 8.8.8.8 every 30s, forces `tailscale down/up` on network recovery
- Solves: ISP outage → Tailscale backoff timer → ~1.5hr reconnection delay

## Pironman5 Vibration Bug
- Code bug: `self.pull` vs `self.pull_up` mismatch in vibration_switch.py line 38
- Config value for pull-up never applied, always uses default True
- Vibration sensor appears non-functional — no log entries on physical tap
- Likely hardware: GPIO cable disconnected or sensor faulty
- Action: Roger to check ribbon/GPIO when physically at Pi

## Late-Night Tunnel & Firewall Fixes (10 PM MT)

### Problem
After Pi hardening + Docker migration, Cloudflare Tunnel URLs (jellyfin.rogergimbel.dev, family.rogergimbel.dev, etc.) stopped working. Errors: 1033 (tunnel unreachable) and 502 (bad gateway).

### Root Causes Found & Fixed

**1. Cloudflared on wrong Docker network**
- During Pi fixes, cloudflared was recreated on `host` network instead of `media_network`
- On `host` it couldn't resolve container names (`caddy`, `jellyfin`, etc.) used in tunnel ingress config
- Fix: `docker compose up -d cloudflared` from `/mnt/media` — compose file correctly specifies `media_network`

**2. UFW DOCKER-USER chain missing conntrack rule (THE BIG ONE)**
- The firewall rules added during hardening allowed outbound traffic from containers (source `172.16.0.0/12` → RETURN)
- But **return packets** from the internet (source = public IP) hit the final DROP rule
- This broke ALL outbound internet access from containers on `media_network`
- Fix: Added `conntrack --ctstate ESTABLISHED,RELATED -j RETURN` as first rule in DOCKER-USER
- Persisted in `/etc/ufw/after.rules` (sed inserted before `ufw-user-forward` line)

**3. Mission Control down**
- Process died during Pi work, restarted via `mission-control/start.sh`

### Key Lesson
When hardening Docker firewall rules, ALWAYS include a conntrack rule for established/related connections at the top of DOCKER-USER. Without it, containers can send packets out but never receive responses.

### Files Modified on Pi
- `/etc/ufw/after.rules` — added conntrack ESTABLISHED,RELATED rule to DOCKER-USER chain
- iptables live rule added via `sudo iptables -I DOCKER-USER 1 -m conntrack --ctstate ESTABLISHED,RELATED -j RETURN`

## M5 MacBook SSH + Summarize Setup (10:10 PM MT)
- Tailscale IP: 100.71.128.20, hostname: rgm5
- OpenClaw SSH key added to `~/.ssh/authorized_keys`
- `summarize` 0.11.1 installed via `brew install steipete/tap/summarize`
- Full path: `/opt/homebrew/bin/summarize` (Homebrew not in non-interactive PATH)
- Usage: `ssh rogergimbel@100.71.128.20 /opt/homebrew/bin/summarize <URL>`
- Updated: network-overview.md, m5-macbook/summary.md, MEMORY.md

## Netdata Restored (10:14 PM MT)
- Container was missing after Docker migration/cleanup — brought back up via `docker compose up -d netdata`
- Rationale: thermal monitoring, disk I/O trends, per-container resource usage worth the ~200-300MB RAM on 8GB Pi
- Access: `netdata.rogergimbel.dev` (Cloudflare Access protected) or `http://100.83.169.87:19999` (Tailscale)
- Persists on reboot: yes (`restart: unless-stopped` + Docker `live-restore`)

## Session Context for Feb 14 (saved for continuity)

### Tonight's Pi Fixes (summary):
1. Cloudflared was on `host` network → moved back to `media_network` via `docker compose up -d`
2. UFW DOCKER-USER missing conntrack rule → added + persisted in `/etc/ufw/after.rules`
3. Mission Control was down → restarted
4. Netdata was missing → restored via `docker compose up -d netdata`

### M5 MacBook Setup:
- Tailscale: 100.71.128.20, hostname: rgm5
- SSH key authorized, summarize 0.11.1 installed
- Path: `/opt/homebrew/bin/summarize`

### MC v3 Progress:
- API: 35 endpoints, all working
- Fixed: health endpoint (CLI not HTTP), overnight build race condition
- Frontend: Lovable project created, first pass complete, all 6 pages scaffolded
- Cloudflare Access removed from mission.rogergimbel.dev
- **NEXT:** Verify Lovable connects to live API, test all pages, fix mismatches

## Get-to-Know-You
- **If you could automate one thing in life:** House cleaning. (Not a tech answer — a real life answer.)
