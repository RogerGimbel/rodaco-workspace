#!/bin/bash
# bin/sites-watchdog — Keep rodaco-site (3334) and rogergimbel-site (3335) alive
# Called by cron every 2-5 minutes
# Checks BOTH localhost (container) and external IP (Docker port forward)

WORKSPACE="/home/node/workspace"
LOG="/tmp/sites-watchdog.log"
EXTERNAL_IP="100.124.209.59"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

check_and_start() {
  local name="$1"
  local port="$2"
  local server="$WORKSPACE/$name/server.cjs"

  # Check localhost first (is the server process running?)
  local local_status
  local_status=$(curl -s --connect-timeout 2 -o /dev/null -w "%{http_code}" "http://127.0.0.1:$port/")

  # Note: external IP check removed — unreachable from inside Docker container (false positives)
  # Port mappings are managed in docker-compose.yml on the host. Localhost check is sufficient.

  if [ "$local_status" = "200" ]; then
    return 0  # healthy
  fi

  if [ "$local_status" != "200" ]; then
    echo "[$TIMESTAMP] $name (port $port) localhost not responding (HTTP $local_status) — starting..." >> "$LOG"
    # Kill any zombie processes for this server
    pkill -f "node $server" 2>/dev/null
    sleep 1
    nohup node "$server" >> "/tmp/$name.log" 2>&1 &
    sleep 2

    local_status=$(curl -s --connect-timeout 2 -o /dev/null -w "%{http_code}" "http://127.0.0.1:$port/")
    if [ "$local_status" = "200" ]; then
      echo "[$TIMESTAMP] $name restarted OK (localhost)" >> "$LOG"
    else
      echo "[$TIMESTAMP] $name FAILED to restart (localhost HTTP $local_status)" >> "$LOG"
      return 1
    fi
  fi

  # (external IP check removed — not reachable from inside Docker)
}

check_and_start "rodaco-site" 3334
RODACO=$?
check_and_start "rogergimbel-site" 3335
ROGER=$?

# Return worst status
if [ $RODACO -ne 0 ] || [ $ROGER -ne 0 ]; then
  exit 1
fi
exit 0
