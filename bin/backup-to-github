#!/usr/bin/env bash
# Push workspace to GitHub (versioned offsite backup)
# Requires: GITHUB_TOKEN env var or git credential helper configured

set -euo pipefail

WORKSPACE="/home/node/workspace"
DATE=$(date +%Y-%m-%d)
TIME=$(date +%H:%M)

log() { echo "[git-backup ${TIME}] $*"; }

cd "$WORKSPACE"

# Check if remote is reachable
if ! git ls-remote --exit-code origin &>/dev/null; then
    log "ERROR: Cannot reach GitHub remote"
    exit 1
fi

# Stage all tracked + new files (gitignore handles exclusions)
git add -A

# Check if there are changes to commit
if git diff --cached --quiet; then
    log "No changes to commit"
    exit 0
fi

# Commit and push
git commit -m "auto-backup: ${DATE} ${TIME}" --no-verify
git push origin main

log "Pushed to GitHub âœ…"
